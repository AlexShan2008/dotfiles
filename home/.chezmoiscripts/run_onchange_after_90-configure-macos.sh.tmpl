{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# Configure macOS system preferences via defaults write.
# Re-runs automatically when this script is modified.

set -uo pipefail

# Do NOT use "set -e" here — individual `defaults write` commands may fail
# for legitimate reasons (sandboxed app containers, SIP-protected domains,
# or keys removed in newer macOS versions) and must not abort the script.

echo "[INFO] Configuring macOS defaults..."

# Helper: run a command, log a warning with the original error on failure,
# then continue to the next command.
try_defaults() {
  local err
  if ! err=$("$@" 2>&1); then
    echo "[WARN] Failed: $*"
    [ -n "$err" ] && echo "        -> $err"
  fi
}

# macOS version (e.g., 14.2.1)
MACOS_VERSION="$(sw_vers -productVersion)"

# Compare dotted versions: returns 0 if $1 >= $2
version_ge() {
  [ "$(printf '%s\n' "$1" "$2" | sort -V | head -n1)" = "$2" ]
}

# Close System Settings to prevent it from overriding our changes
if version_ge "$MACOS_VERSION" "13.0"; then
  osascript -e 'tell application "System Settings" to quit' 2>/dev/null || true
else
  osascript -e 'tell application "System Preferences" to quit' 2>/dev/null || true
fi
sleep 1

# ---------------------------------------------------------------------------
# Keyboard
# ---------------------------------------------------------------------------
# Fast key repeat rate (lower = faster, default is 6)
try_defaults defaults write NSGlobalDomain KeyRepeat -int 2
try_defaults defaults write NSGlobalDomain InitialKeyRepeat -int 25
# Rollback:
# defaults delete NSGlobalDomain KeyRepeat
# defaults delete NSGlobalDomain InitialKeyRepeat
# Disable press-and-hold for accent characters, enable key repeat
try_defaults defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false
# Rollback:
# defaults delete NSGlobalDomain ApplePressAndHoldEnabled
# Use per-app input source (each app remembers its own input method)
try_defaults defaults write com.apple.HIToolbox AppleGlobalTextInputProperties -dict TextInputGlobalPropertyPerContextInput 1

# ---------------------------------------------------------------------------
# Trackpad
# ---------------------------------------------------------------------------
# Enable tap to click
try_defaults defaults write com.apple.AppleMultitouchTrackpad Clicking -bool true
try_defaults defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
try_defaults defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

# ---------------------------------------------------------------------------
# Mouse
# ---------------------------------------------------------------------------
try_defaults defaults write NSGlobalDomain com.apple.mouse.scaling -float 1

# ---------------------------------------------------------------------------
# Sound
# ---------------------------------------------------------------------------
# Play feedback sound when volume is changed
try_defaults defaults write NSGlobalDomain com.apple.sound.beep.feedback -int 1

# ---------------------------------------------------------------------------
# Appearance
# ---------------------------------------------------------------------------
# Follow system (auto)
try_defaults defaults write NSGlobalDomain AppleInterfaceStyleSwitchesAutomatically -bool true
defaults delete NSGlobalDomain AppleInterfaceStyle 2>/dev/null || true
# Rollback:
# defaults delete NSGlobalDomain AppleInterfaceStyleSwitchesAutomatically
# defaults delete NSGlobalDomain AppleInterfaceStyle
# Always show scroll bars
try_defaults defaults write NSGlobalDomain AppleShowScrollBars -string "Always"

# ---------------------------------------------------------------------------
# Dock
# ---------------------------------------------------------------------------
# Auto-hide the Dock
try_defaults defaults write com.apple.dock autohide -bool true
# Set icon size to 46 pixels
try_defaults defaults write com.apple.dock tilesize -int 46
# Enable magnification
try_defaults defaults write com.apple.dock magnification -bool true
# Use scale effect for minimizing
try_defaults defaults write com.apple.dock mineffect -string "scale"
# Don't show recent apps
try_defaults defaults write com.apple.dock show-recents -bool false
# Rollback:
# defaults delete com.apple.dock autohide
# defaults delete com.apple.dock tilesize
# defaults delete com.apple.dock magnification
# defaults delete com.apple.dock mineffect
# defaults delete com.apple.dock show-recents

# ---------------------------------------------------------------------------
# Finder
# ---------------------------------------------------------------------------
# Show status bar
try_defaults defaults write com.apple.finder ShowStatusBar -bool true
# Show path bar
try_defaults defaults write com.apple.finder ShowPathbar -bool true
# Show all filename extensions
try_defaults defaults write NSGlobalDomain AppleShowAllExtensions -bool true
# Keep folders on top when sorting by name
try_defaults defaults write com.apple.finder _FXSortFoldersFirst -bool true
# Search the current folder by default
try_defaults defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"
# Disable the warning when changing a file extension
try_defaults defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false
# Avoid creating .DS_Store files on network or USB volumes
try_defaults defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
try_defaults defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true

# ---------------------------------------------------------------------------
# Window Manager
# ---------------------------------------------------------------------------
# Don't show desktop when clicking wallpaper
if version_ge "$MACOS_VERSION" "13.0"; then
  try_defaults defaults write com.apple.WindowManager EnableStandardClickToShowDesktop -bool false
  # Rollback:
  # defaults delete com.apple.WindowManager EnableStandardClickToShowDesktop
else
  echo "[INFO] Skipping WindowManager setting (requires macOS 13+)."
fi

# ---------------------------------------------------------------------------
# Text input & autocorrect
# ---------------------------------------------------------------------------
# Disable automatic spelling correction
try_defaults defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false
try_defaults defaults write NSGlobalDomain WebAutomaticSpellingCorrectionEnabled -bool false
# Disable smart dash and quote substitution
try_defaults defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false
try_defaults defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false

# ---------------------------------------------------------------------------
# Save & print dialogs
# ---------------------------------------------------------------------------
# Save to disk (not iCloud) by default
try_defaults defaults write NSGlobalDomain NSDocumentSaveNewDocumentsToCloud -bool false
# Expand save panel by default
try_defaults defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true
try_defaults defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode2 -bool true
# Expand print panel by default
try_defaults defaults write NSGlobalDomain PMPrintingExpandedStateForPrint2 -bool true

# ---------------------------------------------------------------------------
# Menu bar
# ---------------------------------------------------------------------------
# Hide AirPlay icon in menu bar
if version_ge "$MACOS_VERSION" "12.0"; then
  try_defaults defaults write com.apple.airplay showInMenuBarIfPresent -bool false
  # Rollback:
  # defaults delete com.apple.airplay showInMenuBarIfPresent
else
  echo "[INFO] Skipping AirPlay menu bar setting (requires macOS 12+)."
fi

# ---------------------------------------------------------------------------
# Login & session
# ---------------------------------------------------------------------------
# Don't reopen windows on login
try_defaults defaults write com.apple.loginwindow TALLogoutSavesState -bool false

# ---------------------------------------------------------------------------
# Safari — intentionally skipped
# ---------------------------------------------------------------------------
# Since Safari 13, preferences live in a sandboxed container:
#   ~/Library/Containers/com.apple.Safari/Data/Library/Preferences/
# Writing to com.apple.Safari requires granting Terminal "Full Disk Access"
# (System Settings > Privacy & Security > Full Disk Access), which an
# automated bootstrap script cannot assume. Enable the Develop menu manually:
#   Safari > Settings > Advanced > "Show features for web developers"

# ---------------------------------------------------------------------------
# Activate settings & restart affected services
# ---------------------------------------------------------------------------
ACTIVATE_SETTINGS="/System/Library/PrivateFrameworks/SystemAdministration.framework/Resources/activateSettings"
if [ -x "$ACTIVATE_SETTINGS" ]; then
  "$ACTIVATE_SETTINGS" -u
else
  echo "[WARN] activateSettings not found; skipping."
fi
killall Dock Finder 2>/dev/null || true

echo "[INFO] macOS defaults configured"
{{- end }}
